name: Build release zip when pushing tag

on:
  push:
    tags: # This is what we want in the future
    - '*'
    # branches: # This is for testing and run it on every push to main
    # - main

permissions:
  contents: write  # needed to create releases and upload assets

jobs:
  build:
    name: ðŸš€ Build Release ZIP file
    runs-on: ubuntu-latest
    steps:
    
    # Checkout the code from the repository
    - name: ðŸšš Checkout
      uses: actions/checkout@v4

    # Create the zip file excluding files and directories listed in .distignore
    - name: ðŸ“¦ Zip Release
      run: |
        echo "Reading exclusions from .distignore..."
        EXCLUSIONS=""
        while IFS= read -r line || [ -n "$line" ]; do
            # Trim whitespace
            line=$(echo "$line" | xargs)
            # Skip empty lines and comments (lines starting with #)
            if [[ -n "$line" && ! "$line" =~ ^# ]]; then
                # Handle both patterns with and without wildcards
                EXCLUSIONS="$EXCLUSIONS -x \"$line\""
            fi
        done < ".distignore"

        echo "Creating zip with exclusions from .distignore"
        echo "Exclusions: $EXCLUSIONS"

        # Use eval to properly handle the quoted exclusions
        eval zip -r "a-test-plugin.zip" . $EXCLUSIONS
        
        echo "Zip file created. Contents:"
        unzip -l "a-test-plugin.zip" | head -20
    
    # Create release and upload the zip file as an asset using https://github.com/marketplace/actions/gh-release
    - name: ðŸ“£ Publish Release on GitHub
      uses: softprops/action-gh-release@v2.3.3
      with:
        tag_name: ${{ github.ref_name }}
        name: ${{ github.ref_name }}
        draft: false
        prerelease: false
        files: a-test-plugin.zip